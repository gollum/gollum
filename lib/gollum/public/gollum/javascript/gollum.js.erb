// Helpers

// Get path for named route, prefixing baseUrl if necessary
// Uses the route definitions in /lib/gollum/views/helpers.rb.
// For example, routePath('delete') is equivalent to 'delete_path' in the mustache templates.
function routePath(name){
  var routes = $.parseJSON('<%= routes_to_json %>')
  path = routes[name]
  if (baseUrl == undefined ) {
    console.log('Gollum error: baseUrl undefined')
  } else if (path == undefined ) {
    console.log('Could not find route with name: ' + name)
  } else {
      if ( baseUrl == "") {
        return path;
      } else if (baseUrl.charAt(baseUrl.length -1) == '/') {
        result = baseUrl + path;
      } else {
        result = baseUrl + '/' + path;
      }
    return result.replace(/\/{2}/g, '/')
  }
}

function pageName(){
  // "my/dir/file.md" => "file"
  if (typeof(pageFullPath) == 'undefined') {
      return undefined;
  } else {
      name = pageFullPath.split('/').pop();
      return name.substring(0, name.lastIndexOf('.'));
  } 
}

function pagePath(){
  // "my/dir/file" => "my/dir"
  return typeof(pageFullPath) == 'undefined' ? undefined : pageFullPath.split('/').slice(0,-1).join('/');
}

// Generic HTML escape function
function htmlEscape( str ) {
  // The (slower) alternative is: return $('<div/>').text(str).html();
  // http://stackoverflow.com/questions/1219860/javascript-jquery-html-encoding/7124052#7124052
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;');
}

// Given a page name and a current path, returns a fully qualified path.
function abspath(path, name){
  // Make sure the given path starts at the root.
  if(name[0] != '/'){
    name = '/' + name;
    if (path) {
      name = '/' + path + name;
    }
  }
  var name_parts = name.split('/');
  var newPath = name_parts.slice(0, -1).join('/');
  var newName = name_parts.pop();
  // return array of [path, name]
  return [newPath, newName];
}

// ua
$(document).ready(function() {
  // for deleting the current page
  $('#delete-link').click( function(e) {
    var ok = confirm($(this).data('confirm'));
    if ( ok ) {
      $.post(routePath('delete') + '/' + pageFullPath,
        {},
        function (result) {
          // page successfully deleted, return to landing page
          window.location = '/';
        });
    }
    // Don't navigate on cancel.
    e.preventDefault();
  } );
  // for deleting files and pages from the overview
  $('.delete-file').click( function(e) {
    var ok = confirm($(this).data('confirm'));
    if ( ok ) {
      var element = $(this);
      $.post(routePath('delete') + '/' + $(this).data('file-path'),
        {},
        function (result) {
          // file successfully deleted, stay on overview but remove element from DOM
          element.closest("li").remove();
        });
    }
    // Don't navigate on cancel.
    e.preventDefault();
  } );

  // ua detection
  if ($.browser.mozilla) {
    $('body').addClass('ff');
  } else if ($.browser.webkit) {
    $('body').addClass('webkit');
  } else if ($.browser.msie) {
    $('body').addClass('ie');
    if ($.browser.version == "7.0") {
      $('body').addClass('ie7');
    } else if ($.browser.version == "8.0") {
      $('body').addClass('ie8');
    }
  }

  if ($('#minibutton-upload-page').length) {
    $('#minibutton-upload-page').parent().removeClass('jaws');
    $('#minibutton-upload-page').click(function(e) {
      e.preventDefault();
      
      $.GollumDialog.init({
        title: 'Upload File',
        fields: [
          {
            type:   'file',
            context: 'Your uploaded file will be accessible at<br>/'+uploadDest+'/[filename]',
            action: routePath('upload_file')
          }
        ],
        OK: function( res ) {
          $('#wiki-content').addClass('uploading');
          var formData = new FormData($('#upload').get(0));
          var endpoint = $('#upload').attr("action");

          $.ajax({
            url: endpoint,
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(data) {
              // File successfully uploaded
              $('#wiki-content').removeClass('uploading');
            },
            error: function(data, textStatus, errorThrown) {
              $('#wiki-content').removeClass('uploading');
              if (data.status == 409) {
                alert('This file already exists.');  
              } else {
                alert('Error uploading file: ' + textStatus + ' ' + errorThrown);
              }  
            }
          });
        }
      });
      $('#gollum-dialog-action-ok').attr('disabled', true);
      $('input:file').on('change', function() {
        if ($(this).val()) {
          news = 'Your uploaded file will be accessible at<br>/' + uploadDest + '/' + $('input[type=file]').val().split('\\').pop();
          $(".context").html(news);
          $('#gollum-dialog-action-ok').attr('disabled', false);

        };
      });
    });
  }

  if ($('#minibutton-rename-page').length) {
    $('#minibutton-rename-page').parent().removeClass('jaws');
    $('#minibutton-rename-page').click(function(e) {
      e.preventDefault();

      var path = pagePath();
      var oldName = pageName();
      var context_blurb =
        "Renamed page will be under " +
        "<span class='path'>" + htmlEscape('/' + path) + "</span>" +
        " unless an absolute path is given."

      $.GollumDialog.init({
        title: 'Rename Page',
        fields: [
          {
            id:   'name',
            name: 'Rename to',
            type: 'text',
            defaultValue: oldName || '',
            context: context_blurb
          }
        ],
        OK: function( res ) {
          var newName = 'Rename Page';
          if ( res['name'] ) {
            newName = res['name'];
          }
          var name_parts = abspath(path, newName);
          var newPath = name_parts[0];

          var msg = '/' + path == newPath ? 'Renamed ' + oldName + ' to ' + newName
                                          : 'Renamed ' + oldName + ' to ' + name_parts.join('/');
          // Fill in the rename form
          // This is preferable to AJAX so that we automatically follow the 302 response.
          var rename_form = $("form[name=rename]");
          rename_form.children("input[name=rename]").val(name_parts.join('/'));
          rename_form.children("input[name=message]").val(msg);
          rename_form.submit();
        }
      });
    });
  }

  if ($('#minibutton-new-page').length) {
    $('#minibutton-new-page').parent().removeClass('jaws');
    $('#minibutton-new-page').click(function(e) {
      e.preventDefault();

      var path = pagePath();
      if( path === undefined && $('#file-browser').length != 0 ){
        // In the pages view, pageFullPath isn't defined.
        // The new button will still expect a value however.
        // So we try to figure one out from window.location
        path = window.location.pathname.replace(routePath('overview'), '')
        // For consistency remove the trailing /
        path = path.replace(/\/$/,'')
      }
      var context_blurb =
        "Page will be created under " +
        "<span class='path'>" + htmlEscape('/' + path) + "</span>" +
        " unless an absolute path is given."

      $.GollumDialog.init({
        title: 'Create New Page',
        fields: [
          {
            id:   'name',
            name: 'Page Name',
            type: 'text',
            defaultValue: '',
            context: context_blurb
          }
        ],
        OK: function( res ) {
          var name = 'New Page';
          if ( res['name'] ) {
            name = res['name'];
          }
          var name_encoded = [];
          var name_parts = abspath(path, name).join('/').split('/');
          // Split and encode each component individually.
          for( var i=0; i < name_parts.length; i++ ){
            name_encoded.push(encodeURIComponent(name_parts[i]));
          }
          window.location =  routePath('create') + name_encoded.join('/');
        }
      });
    });
  }

  if ($('#wiki-wrapper').hasClass('history')) {
    $('#wiki-history td.checkbox input').each(function() {
      $(this).click(function() {
        nodeSelector.checkNode($(this));
      });
      if ( $(this).is(':checked') ) {
        nodeSelector.checkNode($(this));
      }
    });

    if ($('.history button.action-compare-revision').length) {
      $('.history button.action-compare-revision').click(function() {
        $("#selection-form").submit();
      });
    }
  }

  if ($('#searchbar a#search-submit').length) {
    $.GollumPlaceholder.add($('#searchbar #search-query'));
    $('#searchbar a#search-submit').click(function(e) {
      e.preventDefault();
      $('#searchbar #search-form')[0].submit();
    });
    $('#searchbar #search-form').submit(function(e) {
      $.GollumPlaceholder.clearAll();
      $(this).unbind('submit');
      $(this).submit();
    });
  }

  if ($('#gollum-revert-form').length &&
      $('.gollum-revert-button').length ) {
    $('a.gollum-revert-button').click(function(e) {
      e.preventDefault();
      $('#gollum-revert-form').submit();
    });
  }

  if( $('.tabnav-tabs').length ){
    $(".tabnav-tab").click( function() {
      if( ! $(this).hasClass('selected')) {
        tab_id = $(this).attr('id');
        if (tab_id == 'preview') {
          var formData = new FormData($('#gollum-editor-form').get(0));
          var paths = window.location.pathname.split('/');
          formData.append('page', paths[ paths.length - 1 ] || '')
          $.ajax({
            url: routePath('preview'),
            data: formData,
            type: 'POST',
            processData: false,
            contentType: false,
            success: function(data) {
              var mainDiv = $('#wiki-wrapper', data);
              $('.tabnav-div#preview-content').html(mainDiv);
            },
            error: function(data, textStatus, errorThrown) {
              console.log('something went wrong: ' + textStatus + errorThrown);
            }
          });
        }
        $('.tabnav-tab.selected').removeClass('selected');
        $(this).addClass('selected');
        active_div = '#' + tab_id + "-content";
        $('.tabnav-div').hide();
        $(active_div).show();
      };
    });
  };

  if( $('#wiki-wrapper.edit').length ){
    $("#gollum-editor-submit").click( function() { window.onbeforeunload = null; } );
    $("#gollum-editor-body").one('change', function(){
      window.onbeforeunload = function(){ return "Leaving will discard all edits!" };
    });
    $.GollumEditor();
    $("#gollum-editor-submit").click( function(e) {
      e.preventDefault();
      // Prevent button from being clicked again
      $(this).attr('disabled', true);

      var formData = new FormData($('#gollum-editor-form').get(0));
      var endpoint = $('#gollum-editor-form').attr("action");

      $.ajax({
        url: endpoint,
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function(data) {
          window.location = window.location.href.replace(/gollum\/edit\//, '')
        },
        error: function(data, textStatus, errorThrown) {
          if (data.status == 412) {
            $('#gollum-editor-submit').attr('disabled', false)
            alert('Someone else has modified this page while you were editing it. Please store your version on disk outside of the browser, reload this page and reapply your modifications.');
          } else {
            alert('Error updating page: ' + textStatus + ' ' + errorThrown);
          }  
        }
      });
      
    });
  }

  if( $("#page-history").length) {
    if( $("#page-history #pagination").length) {

      var maxSelected = 2;
      var selectionColors = ["bg-green-light", "bg-red-light"];

      var toggleInputs = function () {
        var numSelected = 0;
        $("#selection-form input").each(function (index, element) {
          var value = $(element).val();
          var input = $('#version-form input[value="' + value + '"]');
          input.prop('checked', true);
          if (index == 0) {
            input.closest("li").removeClass(selectionColors[1]).addClass(selectionColors[index]);
          } else if (index == 1) {
            input.closest("li").addClass(selectionColors[index]); 
          }
          numSelected = numSelected + 1;
        });
        if (numSelected == maxSelected) {
          $('#version-form input:not(:checked)').prop('disabled', true);
          $('.history button.action-compare-revision').prop('disabled', false);
        } else if (numSelected < maxSelected) {
          $('#version-form input').prop('disabled', false);
          $('.history button.action-compare-revision').prop('disabled', true);
        }
      };

      var onCheckboxSelect = function ( box ) {
        $('<input>').attr({
          type: 'hidden',
          id: $(box).val(),
          name: 'versions[]',
          value: $(box).val()
        }).appendTo($("#selection-form"));
        toggleInputs();
      };

      var onCheckboxUnselect = function( box ) {
        $('#selection-form #' + $(box).val()).remove();
        $(box).closest("li").removeClass(selectionColors.join(" "));
        toggleInputs();
      };

      var setCheckboxEvents = function () {
        $("#version-form input").on('change', function () {
          if (this.checked) {
            onCheckboxSelect(this);
          } else {
            onCheckboxUnselect(this);
          }
        });
      };
      setCheckboxEvents();
      toggleInputs();

      var clickPageNav = function (e) {
        e.preventDefault();
        $.ajax({
            url: $(this).attr('href'),
            type: 'GET',
            success: function(data) {
              var rowDiv = $('#page-history-list', data);
              var new_pagination = $('#pagination', data);

              next = $('#pagination #next');
              prev = $('#pagination #prev');
              new_next = new_pagination.find('#next');
              new_prev = new_pagination.find('#prev');

              next[0].hidden = new_next[0].hidden;
              prev[0].hidden = new_prev[0].hidden;

              next.children('a').attr('href', new_next.children('a').attr('href'));
              prev.children('a').attr('href', new_prev.children('a').attr('href'));

              $('#page-history-list').replaceWith(rowDiv);

              setCheckboxEvents();
              toggleInputs();
            },
            error: function(data, textStatus, errorThrown) {
              console.log('something went wrong: ' + textStatus + errorThrown)
            }
        });
      };

      $("#pagination #next a, #pagination #prev a").each(function(index, element) {
       $(element).on("click", clickPageNav);
      });
    }
  }

  if( $("#last-edit").length ) {
    $("#page-info-toggle").click ( function () {
      $.ajax({
        url: routePath('last_commit_info'),
        data: {path: $("#page-info-toggle").data('pagepath')},
        success: function ( data ) {
          $("#last-edit").next(".dotted-spinner").toggleClass('hidden');
          $("#last-edit-in-progress").html('Last edited by <b>' + data.author + '</b>, ' + data.date);
        }
      });
      $("#last-edit").next(".dotted-spinner").toggleClass('hidden')
      $("#page-info-toggle").before('<span id="last-edit-in-progress">&nbsp;Getting commit info...</span>').remove();
    })
  }

  if( $('#wiki-wrapper.create').length ){
    $("#gollum-editor-submit").click( function() { window.onbeforeunload = null; } );
    $("#gollum-editor-body").one('change', function(){
      window.onbeforeunload = function(){ return "Leaving will not create a new page!" };
    });
    $.GollumEditor({ NewFile: true, MarkupType: default_markup });
  }

  // CriticMarkup
  if(criticMarkup == 'true') {
    $('#wiki-content').addClass('criticmarkup');
    $('ins.break').unwrap();
    $('span.critic.comment').wrap('<span class="popover" />');
    $('span.critic.comment').filter(function() {return $(this).text()!="";}).before('&#8225;');
  }

  if($('#wiki-content').length ){
    // Set text direction auto
    $('.markdown-body p, .markdown-body span, .markdown-body pre, .markdown-body table').attr('dir','auto');

    // Copy anchors for each editable header and give the new anchor the 'edit' class, to display an "edit section" link
    $('a.anchor').each(function (index, anchor) {
      header = $(anchor).closest(':header');
      if (header.hasClass('editable')){
        var newUrl = routePath('edit') + '/' + pageName() + $(anchor).attr('href');
        $(anchor).clone().addClass('edit').attr('href', newUrl).appendTo(header);
      }
    });
  }

  if( $('#wiki-history').length ){
    var lookup = {};
    $('img.identicon').each(function(index, element){
      var $item   = $(element);
      var code    = parseInt($item.data('identicon'), 10);
      var img_bin = lookup[code];
      if( img_bin === undefined ){
        var size = 16;
        var canvas = $('<canvas width=16 height=16/>').get(0);
        render_identicon(canvas, code, 16);
        img_bin = canvas.toDataURL("image/png");
        lookup[code] = img_bin;
      }
      $item.attr('src', img_bin);
    });
  }
});
